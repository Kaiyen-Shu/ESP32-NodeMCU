<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino éŠæˆ²æ§åˆ¶å™¨</title>
    <script src="config.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .panel {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 12px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .primary {
            background: #007bff;
            color: white;
        }

        .primary:hover {
            background: #0056b3;
        }

        .primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .danger {
            background: #dc3545;
            color: white;
        }

        .success {
            background: #28a745;
            color: white;
        }

        .matrix {
            display: grid;
            grid-template-columns: repeat(3, 80px);
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            width: 80px;
            height: 80px;
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.2s;
        }

        .btn.active {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
            transform: scale(0.95);
        }

        /* æ–°å¢ï¼šåŠŸèƒ½æŒ‰éˆ•åç™½æ•ˆæœ */
        .btn.highlight {
            background: #ffc107 !important;
            color: #212529 !important;
            border-color: #e0a800 !important;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            animation: flash 0.5s ease-in-out;
        }

        @keyframes flash {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .btn.x {
            background: #007bff;
            color: white;
        }

        .btn.o {
            background: #dc3545;
            color: white;
        }

        .btn.sequence {
            background: #ffc107;
            color: #212529;
        }

        .btn.correct {
            background: #28a745;
            color: white;
        }

        .btn.wrong {
            background: #dc3545;
            color: white;
        }

        .game-container {
            display: none;
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            margin-top: 20px;
        }

        .game-container.active {
            display: block;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .game-info {
            text-align: center;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            margin: 15px 0;
        }

        .score {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }

        .score-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            min-width: 100px;
        }

        .reaction-area {
            text-align: center;
            padding: 40px;
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            margin: 20px 0;
            background: #f8f9fa;
        }

        .reaction-area.ready {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .reaction-area.go {
            background: #d4edda;
            border-color: #28a745;
        }

        .number-input {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .number-display {
            font-size: 48px;
            font-weight: bold;
            color: #007bff;
            min-width: 150px;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 0.5s;
        }

        .connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* ç‰¹æ®ŠæŒ‰éˆ•å°ˆç”¨æ¨£å¼ */
        .special-button {
            padding: 15px 25px;
            margin: 10px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* Reset æŒ‰éˆ•æ¨£å¼ */
        .reset-btn {
            background: linear-gradient(145deg, #dc3545, #c82333);
            color: white;
            border-color: #bd2130;
        }

        .reset-btn.active {
            background: linear-gradient(145deg, #fff, #f8f9fa);
            color: #dc3545;
            border-color: #dc3545;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.5);
            transform: scale(1.1);
        }

        /* Game Select æŒ‰éˆ•æ¨£å¼ */
        .game-select-btn {
            background: linear-gradient(145deg, #ffc107, #e0a800);
            color: #212529;
            border-color: #d39e00;
        }

        .game-select-btn.active {
            background: linear-gradient(145deg, #fff, #f8f9fa);
            color: #ffc107;
            border-color: #ffc107;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
            transform: scale(1.1) rotate(5deg);
        }

        /* Confirm æŒ‰éˆ•æ¨£å¼ */
        .confirm-btn {
            background: linear-gradient(145deg, #28a745, #1e7e34);
            color: white;
            border-color: #1c7430;
        }

        .confirm-btn.active {
            background: linear-gradient(145deg, #fff, #f8f9fa);
            color: #28a745;
            border-color: #28a745;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
            transform: scale(1.1);
        }

        /* æŒ‰éˆ•æŒ‰ä¸‹å‹•ç•« */
        @keyframes buttonPress {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.95);
            }

            100% {
                transform: scale(1.05);
            }
        }

        .button-pressed {
            animation: buttonPress 0.3s ease;
        }

        /* æ³¢ç´‹æ•ˆæœ */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* æç¤ºæ–‡å­—å‹•ç•« */
        .action-hint {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            font-size: 18px;
            font-weight: bold;
            animation: fadeInOut 1.5s ease;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        /* éŠæˆ²é¸æ“‡å½ˆå‡ºè¦–çª— */
        .game-selector-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .game-selector-overlay.show {
            display: flex;
        }

        .game-selector {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            animation: slideIn 0.3s ease;
        }

        .game-selector h2 {
            text-align: center;
            margin: 0 0 20px 0;
            color: #333;
            font-size: 24px;
        }

        .game-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .game-option {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .game-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .game-option.selected {
            border-color: #007bff;
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            transform: scale(1.05);
        }

        .game-option.highlighted {
            animation: pulse 1s infinite;
            border-color: #ffc107;
            background: linear-gradient(145deg, #fff3cd, #ffeaa7);
        }

        .game-option .game-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #007bff;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .game-option .game-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        .game-option .game-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }

        .game-option .game-description {
            font-size: 12px;
            color: #666;
            line-height: 1.3;
        }

        .selector-instructions {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .selector-instructions .instruction-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }

        .selector-instructions .instruction-text {
            font-size: 14px;
            color: #6c757d;
        }

        .selector-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .selector-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .selector-btn.confirm {
            background: #28a745;
            color: white;
        }

        .selector-btn.confirm:hover {
            background: #218838;
        }

        .selector-btn.cancel {
            background: #6c757d;
            color: white;
        }

        .selector-btn.cancel:hover {
            background: #545b62;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
            }
        }

        /* æ•¸å­—éµæç¤ºå‹•ç•« */
        .number-key-hint {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            animation: bounceHint 2s infinite;
        }

        @keyframes bounceHint {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateX(-50%) translateY(0);
            }

            40% {
                transform: translateX(-50%) translateY(-10px);
            }

            60% {
                transform: translateX(-50%) translateY(-5px);
            }
        }

        /* èª¿è©¦é¢æ¿æ¨£å¼ */
        .debug-panel {
            background: #f1f3f4;
            border-left: 5px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .debug-panel h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #333;
        }

        .debug-panel button {
            padding: 10px 15px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .debug-panel .primary {
            background: #007bff;
            color: white;
        }

        .debug-panel .primary:hover {
            background: #0056b3;
        }

        .debug-panel .danger {
            background: #dc3545;
            color: white;
        }

        .debug-panel .success {
            background: #28a745;
            color: white;
        }

        .debug-info {
            font-family: monospace;
            font-size: 12px;
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1>ğŸ® Arduino éŠæˆ²æ§åˆ¶å™¨</h1>

    <!-- é€£æ¥é¢æ¿ -->
    <div class="panel">
        <h3>ğŸ”— é€£æ¥è¨­å®š</h3>
        <input type="text" id="ip" value="192.168.1.100" placeholder="Arduino IP"
            style="padding: 10px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;">
        <button class="primary" id="connectBtn" onclick="connect()">é€£æ¥</button>
        <button class="danger" id="disconnectBtn" onclick="disconnect()">æ–·é–‹</button>
        <div class="status disconnected" id="status">æœªé€£æ¥</div>
    </div>

    <!-- æŒ‰éˆ•ç‹€æ…‹é¢æ¿ -->
    <div class="panel">
        <h3>ğŸ›ï¸ æŒ‰éˆ•ç‹€æ…‹</h3>
        <div class="matrix" id="buttonMatrix">
            <div class="btn" id="btn0">1</div>
            <div class="btn" id="btn1">2</div>
            <div class="btn" id="btn2">3</div>
            <div class="btn" id="btn3">4</div>
            <div class="btn" id="btn4">5</div>
            <div class="btn" id="btn5">6</div>
            <div class="btn" id="btn6">7</div>
            <div class="btn" id="btn7">8</div>
            <div class="btn" id="btn8">9</div>
        </div>
        <div class="controls">
            <button id="resetBtn" class="danger">é‡ç½®</button>
            <button id="gameBtn" class="primary">éŠæˆ²é¸æ“‡</button>
            <button id="confirmBtn" class="success">ç¢ºèª</button>
        </div>
    </div>

    <!-- éŠæˆ²æ§åˆ¶é¢æ¿ -->
    <div class="panel">
        <h3>ğŸ® éŠæˆ²æ§åˆ¶</h3>
        <div class="controls">
            <button class="primary" onclick="toggleMonitoring()">é–‹å§‹éŠæˆ²ç›£æ§</button>
            <button class="success" onclick="startCurrentGame()">é–‹å§‹éŠæˆ²</button>
            <button class="danger" onclick="resetCurrentGame()">é‡ç½®éŠæˆ²</button>
        </div>
        <div id="gameArea"></div>
    </div>

    <!-- éŠæˆ²é¸æ“‡å½ˆå‡ºè¦–çª— -->
    <div class="game-selector-overlay" id="gameSelectorOverlay">
        <div class="game-selector">
            <h2>ğŸ® é¸æ“‡éŠæˆ²æ¨¡å¼</h2>

            <div class="selector-instructions">
                <div class="instruction-title">æ“ä½œèªªæ˜</div>
                <div class="instruction-text">
                    ä½¿ç”¨æ•¸å­—éµ 1-3 é¸æ“‡éŠæˆ²ï¼Œç„¶å¾ŒæŒ‰ç¢ºèªéµé–‹å§‹
                </div>
            </div>

            <div class="game-options" id="gameOptions">
                <div class="game-option" data-game="0">
                    <div class="game-number">1</div>
                    <div class="number-key-hint">æŒ‰ 1</div>
                    <div class="game-icon">â­•</div>
                    <div class="game-name">äº•å­—éŠæˆ²</div>
                    <div class="game-description">ç¶“å…¸çš„ä¸‰é€£ç·šéŠæˆ²ï¼Œèˆ‡é›»è…¦å°æˆ°</div>
                </div>

                <div class="game-option" data-game="1">
                    <div class="game-number">2</div>
                    <div class="number-key-hint">æŒ‰ 2</div>
                    <div class="game-icon">ğŸ§ </div>
                    <div class="game-name">è¨˜æ†¶éŠæˆ²</div>
                    <div class="game-description">è¨˜ä½æŒ‰éˆ•åºåˆ—ä¸¦æ­£ç¢ºé‡è¤‡</div>
                </div>

                <div class="game-option" data-game="2">
                    <div class="game-number">3</div>
                    <div class="number-key-hint">æŒ‰ 3</div>
                    <div class="game-icon">âš¡</div>
                    <div class="game-name">åæ‡‰éŠæˆ²</div>
                    <div class="game-description">æ¸¬è©¦ä½ çš„åæ‡‰é€Ÿåº¦å’Œå°ˆæ³¨åŠ›</div>
                </div>

            </div>

            <div class="selector-controls">
                <button class="selector-btn confirm" onclick="confirmGameSelection()">
                    âœ… ç¢ºèªé¸æ“‡
                </button>
                <button class="selector-btn cancel" onclick="closeGameSelector()">
                    âŒ å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- èª¿è©¦é¢æ¿ -->
    <div class="debug-panel" id="debugPanel">
        <h3>ğŸ”§ èª¿è©¦å·¥å…·</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button onclick="testAllButtons()" class="primary">æ¸¬è©¦æ‰€æœ‰æŒ‰éˆ•</button>
            <button onclick="clearEventQueue()" class="danger">æ¸…é™¤äº‹ä»¶éšŠåˆ—</button>
            <button onclick="toggleDebugMode()" class="success">åˆ‡æ›èª¿è©¦æ¨¡å¼</button>
        </div>
        <div id="debugInfo">
            èª¿è©¦è³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡...
        </div>
    </div>

    <script src="games.js"></script>
    <script>
        class ArduinoController {
            constructor() {
                this.ip = '';
                this.connected = false;
                this.monitoring = false;
                this.interval = null;
                this.gameEngine = new GameEngine();
                this.lastButtonStates = Array(9).fill(false);
                this.lastSpecialStates = { reset: false, gameSelect: false, confirm: false };
                this.requestCount = 0;
                this.connectionTime = null;
                this.gameSelectorOpen = false;
                this.selectedGameId = 0;
                this.gameSelectorTimeout = null;
                this.buttonEventQueue = [];
                this.processingEvents = false;
                this.connectionRetries = 0;
                this.maxRetries = 3;
            }

            updateConnectionButtons(connected) {
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');

                if (connectBtn) {
                    connectBtn.disabled = connected;
                    connectBtn.textContent = connected ? 'å·²é€£æ¥' : 'é€£æ¥';
                }

                if (disconnectBtn) {
                    disconnectBtn.disabled = !connected;
                }
            }

            async connect() {
                this.ip = document.getElementById('ip').value.trim();
                if (!this.ip) {
                    this.updateStatus('è«‹è¼¸å…¥ Arduino IP åœ°å€', 'disconnected');
                    return;
                }

                this.connectionRetries = 0;
                this.updateConnectionButtons(false); // ç¦ç”¨é€£æ¥æŒ‰éˆ•
                await this.attemptConnection();
            }

            async attemptConnection() {
                try {
                    this.updateStatus(`æ­£åœ¨é€£æ¥... (å˜—è©¦ ${this.connectionRetries + 1}/${this.maxRetries})`, 'connecting');
                    console.log(`ğŸ”Œ å˜—è©¦é€£æ¥åˆ°: http://${this.ip}`);

                    // å…ˆç™¼é€ OPTIONS è«‹æ±‚æª¢æŸ¥ CORS
                    try {
                        const optionsResponse = await fetch(`http://${this.ip}/`, {
                            method: 'OPTIONS',
                            mode: 'cors',
                            headers: {
                                'Access-Control-Request-Method': 'GET',
                                'Access-Control-Request-Headers': 'Content-Type'
                            }
                        });
                        console.log('âœ… OPTIONS è«‹æ±‚æˆåŠŸ');
                    } catch (optionsError) {
                        console.warn('âš ï¸ OPTIONS è«‹æ±‚å¤±æ•—ï¼Œç¹¼çºŒå˜—è©¦ GET:', optionsError);
                    }

                    // ç­‰å¾…ä¸€å°æ®µæ™‚é–“å†ç™¼é€ä¸»è¦è«‹æ±‚
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // ç™¼é€ä¸»è¦é€£æ¥è«‹æ±‚
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        console.log('â° é€£æ¥è¶…æ™‚ï¼Œä¸­æ­¢è«‹æ±‚');
                        controller.abort();
                    }, 10000); // å»¶é•·è¶…æ™‚æ™‚é–“åˆ° 10 ç§’

                    const response = await fetch(`http://${this.ip}/`, {
                        method: 'GET',
                        mode: 'cors',
                        signal: controller.signal,
                        headers: {
                            'Accept': 'text/plain, */*',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });

                    clearTimeout(timeoutId);

                    console.log(`ğŸ“¡ æ”¶åˆ°å›æ‡‰: ${response.status} ${response.statusText}`);

                    if (response.ok) {
                        const result = await response.text();
                        console.log('ğŸ“¥ Arduino å›æ‡‰å…§å®¹:', result);

                        // æª¢æŸ¥å›æ‡‰å…§å®¹
                        if (result.includes('Arduino') || result.includes('Ready') || result.includes('Controller')) {
                            // é€£æ¥æˆåŠŸï¼Œç­‰å¾…ä¸€ç§’å†é–‹å§‹ç›£æ§
                            this.connected = true;
                            this.connectionTime = new Date();
                            this.timeoutCount = 0; // é‡ç½®è¶…æ™‚è¨ˆæ•¸

                            this.updateStatus(`âœ… é€£æ¥æˆåŠŸ - ${this.ip}`, 'connected');
                            this.updateConnectionButtons(true);

                            // å»¶é²å•Ÿå‹•ç›£æ§ï¼Œç¢ºä¿ Arduino æº–å‚™å°±ç·’
                            setTimeout(() => {
                                if (this.connected) {
                                    this.startMonitoring();
                                    console.log('ğŸ® é–‹å§‹ç›£æ§ Arduino è¼¸å…¥');
                                }
                            }, 1000);

                            // ä¿å­˜æˆåŠŸçš„ IP
                            localStorage.setItem('lastArduinoIP', this.ip);
                            return;
                        } else {
                            throw new Error(`æ„å¤–çš„å›æ‡‰å…§å®¹: ${result}`);
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                } catch (error) {
                    console.error('âŒ é€£æ¥éŒ¯èª¤:', error);
                    this.connectionRetries++;

                    if (this.connectionRetries < this.maxRetries) {
                        const delay = 3000; // å¢åŠ é‡è©¦å»¶é²
                        this.updateStatus(`é€£æ¥å¤±æ•—ï¼Œ${delay / 1000}ç§’å¾Œé‡è©¦... (${this.connectionRetries}/${this.maxRetries})`, 'connecting');
                        setTimeout(() => {
                            this.attemptConnection();
                        }, delay);
                    } else {
                        this.handleConnectionFailure(error);
                    }
                }
            }

            async checkInput() {
                if (!this.connected) return;

                try {
                    this.requestCount++;

                    const response = await fetch(`http://${this.ip}/input`, {
                        method: 'GET',
                        mode: 'cors',
                        signal: AbortSignal.timeout(5000), // å¢åŠ è¶…æ™‚æ™‚é–“
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });

                    if (response.ok) {
                        const text = await response.text();

                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch (parseError) {
                            console.warn('âš ï¸ JSON è§£æéŒ¯èª¤:', parseError, 'åŸå§‹æ–‡å­—:', text);
                            return;
                        }

                        if (data && Array.isArray(data.buttons)) {
                            this.processButtonEvents(data);
                            this.updateButtonDisplay(data);

                            // é‡ç½®è¶…æ™‚è¨ˆæ•¸
                            this.timeoutCount = 0;
                        } else {
                            console.warn('âš ï¸ ç„¡æ•ˆçš„è³‡æ–™æ ¼å¼:', data);
                        }

                        // æ¯ 100 æ¬¡è«‹æ±‚é¡¯ç¤ºä¸€æ¬¡ç‹€æ…‹
                        if (this.requestCount % 100 === 0) {
                            this.updateStatus(`ğŸ”„ é‹è¡Œæ­£å¸¸ - è«‹æ±‚: ${this.requestCount}`, 'connected');
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                } catch (error) {
                    if (error.name === 'TimeoutError' || error.name === 'AbortError') {
                        this.timeoutCount = (this.timeoutCount || 0) + 1;
                        console.warn(`â° è«‹æ±‚è¶…æ™‚ (${this.timeoutCount})`);

                        // é€£çºŒè¶…æ™‚å¤ªå¤šæ¬¡æ‰æ–·é–‹é€£æ¥
                        if (this.timeoutCount > 10) {
                            console.error('ğŸ’” é€£çºŒè¶…æ™‚éå¤šï¼Œæ–·é–‹é€£æ¥');
                            this.handleConnectionLoss();
                        }
                    } else {
                        console.warn('âš ï¸ è¼¸å…¥æª¢æŸ¥å¤±æ•—:', error);
                        this.handleConnectionLoss();
                    }
                }
            }

            startMonitoring() {
                if (this.monitoring) {
                    console.log('âš ï¸ ç›£æ§å·²åœ¨é‹è¡Œ');
                    return;
                }

                this.monitoring = true;
                this.requestCount = 0;
                this.timeoutCount = 0;

                // ä½¿ç”¨è¼ƒä½çš„é »ç‡é–‹å§‹ï¼Œç„¶å¾Œé€æ¼¸èª¿æ•´
                this.interval = setInterval(() => this.checkInput(), 150); // æ¸›æ…¢åˆ° 150ms
                console.log('ğŸ® é–‹å§‹ç›£æ§æŒ‰éˆ•è¼¸å…¥ (é–“éš”: 150ms)');
            }

            handleConnectionFailure(error) {
                this.connected = false;
                this.updateConnectionButtons(false);

                let errorMessage = '';
                if (error.name === 'AbortError') {
                    errorMessage = `â° é€£æ¥è¶…æ™‚ - è«‹æª¢æŸ¥ ${this.ip} æ˜¯å¦æ­£ç¢ºä¸” Arduino æ­£åœ¨é‹è¡Œ`;
                } else if (error.message.includes('CORS')) {
                    errorMessage = `ğŸš« CORS éŒ¯èª¤ - è«‹é‡æ–°å•Ÿå‹• Arduino æˆ–æª¢æŸ¥ç¶²è·¯è¨­å®š`;
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = `ğŸŒ ç„¡æ³•é€£æ¥åˆ° ${this.ip} - è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥å’Œ IP åœ°å€`;
                } else {
                    errorMessage = `âŒ é€£æ¥å¤±æ•—: ${error.message}`;
                }

                this.updateStatus(errorMessage, 'disconnected');
                console.error('âŒ é€£æ¥å¤±æ•—:', error);
            }

            async checkInput() {
                if (!this.connected) return;

                try {
                    this.requestCount++;

                    const response = await fetch(`http://${this.ip}/input`, {
                        method: 'GET',
                        mode: 'cors',
                        signal: AbortSignal.timeout(5000), // å¢åŠ è¶…æ™‚æ™‚é–“
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });

                    if (response.ok) {
                        const text = await response.text();

                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch (parseError) {
                            console.warn('âš ï¸ JSON è§£æéŒ¯èª¤:', parseError, 'åŸå§‹æ–‡å­—:', text);
                            return;
                        }

                        if (data && Array.isArray(data.buttons)) {
                            this.processButtonEvents(data);
                            this.updateButtonDisplay(data);

                            // é‡ç½®è¶…æ™‚è¨ˆæ•¸
                            this.timeoutCount = 0;
                        } else {
                            console.warn('âš ï¸ ç„¡æ•ˆçš„è³‡æ–™æ ¼å¼:', data);
                        }

                        // æ¯ 100 æ¬¡è«‹æ±‚é¡¯ç¤ºä¸€æ¬¡ç‹€æ…‹
                        if (this.requestCount % 100 === 0) {
                            this.updateStatus(`ğŸ”„ é‹è¡Œæ­£å¸¸ - è«‹æ±‚: ${this.requestCount}`, 'connected');
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                } catch (error) {
                    if (error.name === 'TimeoutError' || error.name === 'AbortError') {
                        this.timeoutCount = (this.timeoutCount || 0) + 1;
                        console.warn(`â° è«‹æ±‚è¶…æ™‚ (${this.timeoutCount})`);

                        // é€£çºŒè¶…æ™‚å¤ªå¤šæ¬¡æ‰æ–·é–‹é€£æ¥
                        if (this.timeoutCount > 10) {
                            console.error('ğŸ’” é€£çºŒè¶…æ™‚éå¤šï¼Œæ–·é–‹é€£æ¥');
                            this.handleConnectionLoss();
                        }
                    } else {
                        console.warn('âš ï¸ è¼¸å…¥æª¢æŸ¥å¤±æ•—:', error);
                        this.handleConnectionLoss();
                    }
                }
            }

            processButtonEvents(data) {
                const timestamp = Date.now();

                data.buttons.forEach((current, i) => {
                    if (current && !this.lastButtonStates[i]) {
                        this.buttonEventQueue.push({
                            type: 'button',
                            index: i,
                            timestamp: timestamp
                        });
                        console.log(`ğŸ”˜ æŒ‰éˆ• ${i + 1} è¢«æŒ‰ä¸‹`);
                    }
                    this.lastButtonStates[i] = current;
                });

                ['reset', 'gameSelect', 'confirm'].forEach((key) => {
                    const current = data[key];
                    const last = this.lastSpecialStates[key];

                    if (current && !last) {
                        this.buttonEventQueue.push({
                            type: 'special',
                            key: key,
                            timestamp: timestamp
                        });
                        console.log(`ğŸ”§ ç‰¹æ®ŠæŒ‰éˆ• ${key} è¢«æŒ‰ä¸‹`);
                    }
                    this.lastSpecialStates[key] = current;
                });

                this.processEventQueue(data);
            }

            async processEventQueue(data) {
                if (this.processingEvents || this.buttonEventQueue.length === 0) return;

                this.processingEvents = true;

                while (this.buttonEventQueue.length > 0) {
                    const event = this.buttonEventQueue.shift();
                    await this.handleSingleEvent(event, data);
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                this.processingEvents = false;
            }

            async handleSingleEvent(event, data) {
                try {
                    if (event.type === 'button') {
                        this.handleButtonPress(event.index, data);
                    } else if (event.type === 'special') {
                        this.handleSpecialButtonPress(event.key, data);
                    }
                } catch (error) {
                    console.error('äº‹ä»¶è™•ç†éŒ¯èª¤:', error, event);
                }
            }

            handleButtonPress(buttonIndex, data) {
                console.log(`è™•ç†æŒ‰éˆ• ${buttonIndex + 1} æŒ‰ä¸‹äº‹ä»¶`);
                this.highlightButton(`btn${buttonIndex}`);

                if (this.gameSelectorOpen) {
                    if (buttonIndex < 4) {
                        this.handleGameSelection(buttonIndex);
                    }
                    return;
                }

                if (this.gameEngine.currentGame) {
                    this.gameEngine.currentGame.onButtonPress(buttonIndex);
                }
            }

            handleSpecialButtonPress(key, data) {
                console.log(`è™•ç†ç‰¹æ®ŠæŒ‰éˆ• ${key} æŒ‰ä¸‹äº‹ä»¶`);

                const buttonMap = {
                    reset: 'resetBtn',
                    gameSelect: 'gameBtn',
                    confirm: 'confirmBtn'
                };
                this.highlightButton(buttonMap[key]);

                switch (key) {
                    case 'reset':
                        if (this.gameSelectorOpen) {
                            this.closeGameSelector();
                        } else {
                            this.gameEngine.resetGame();
                        }
                        break;

                    case 'gameSelect':
                        if (!this.gameSelectorOpen) {
                            this.showGameSelector();
                        } else {
                            this.closeGameSelector();
                        }
                        break;

                    case 'confirm':
                        if (this.gameSelectorOpen) {
                            this.confirmGameSelection();
                        } else if (this.gameEngine.currentGame) {
                            if (this.gameEngine.gameId === 3) {
                                this.gameEngine.currentGame.submitGuess();
                            } else {
                                this.gameEngine.currentGame.start();
                            }
                        }
                        break;
                }
            }

            highlightButton(buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.classList.add('highlight');
                    setTimeout(() => {
                        btn.classList.remove('highlight');
                    }, 300);
                }
            }

            handleConnectionLoss() {
                console.error('é€£æ¥ä¸­æ–·');
                this.connected = false;
                this.stopMonitoring();
                this.updateStatus('é€£æ¥ä¸­æ–·', 'disconnected');
                this.updateConnectionButtons(false);
            }

            startMonitoring() {
                if (this.monitoring) {
                    console.log('âš ï¸ ç›£æ§å·²åœ¨é‹è¡Œ');
                    return;
                }

                this.monitoring = true;
                this.requestCount = 0;
                this.timeoutCount = 0;

                // ä½¿ç”¨è¼ƒä½çš„é »ç‡é–‹å§‹ï¼Œç„¶å¾Œé€æ¼¸èª¿æ•´
                this.interval = setInterval(() => this.checkInput(), 150); // æ¸›æ…¢åˆ° 150ms
                console.log('ğŸ® é–‹å§‹ç›£æ§æŒ‰éˆ•è¼¸å…¥ (é–“éš”: 150ms)');
            }

            stopMonitoring() {
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
                this.monitoring = false;
                console.log('åœæ­¢ç›£æ§');
            }

            disconnect() {
                this.connected = false;
                this.stopMonitoring();
                this.updateStatus('å·²æ‰‹å‹•æ–·é–‹', 'disconnected');
                this.updateConnectionButtons(false);
                console.log('æ‰‹å‹•æ–·é–‹é€£æ¥');
            }

            updateButtonDisplay(data) {
                data.buttons.forEach((pressed, i) => {
                    const btn = document.getElementById(`btn${i}`);
                    if (btn) {
                        btn.classList.toggle('active', pressed);
                    }
                });

                this.updateSpecialButton('resetBtn', data.reset);
                this.updateSpecialButton('gameBtn', data.gameSelect);
                this.updateSpecialButton('confirmBtn', data.confirm);
            }

            updateSpecialButton(id, pressed) {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.classList.toggle('active', pressed);
                }
            }

            updateStatus(message, type) {
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.classList.remove('connected', 'disconnected', 'connecting', 'error');

                    switch (type) {
                        case 'connected':
                            statusElement.classList.add('connected');
                            break;
                        case 'connecting':
                            statusElement.classList.add('connecting');
                            break;
                        case 'disconnected':
                        case 'error':
                            statusElement.classList.add('disconnected');
                            break;
                    }
                }

                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] ${message}`);
            }

            showGameSelector() {
                console.log('ğŸ® é¡¯ç¤ºéŠæˆ²é¸æ“‡ç•Œé¢');
                this.gameSelectorOpen = true;
                const overlay = document.getElementById('gameSelectorOverlay');
                if (overlay) {
                    overlay.classList.add('show');
                }
            }

            closeGameSelector() {
                console.log('ğŸšª é—œé–‰éŠæˆ²é¸æ“‡ç•Œé¢');
                this.gameSelectorOpen = false;
                const overlay = document.getElementById('gameSelectorOverlay');
                if (overlay) {
                    overlay.classList.remove('show');
                }
            }

            handleGameSelection(gameId) {
                console.log(`ğŸ¯ é¸æ“‡éŠæˆ²: ${gameId}`);
                this.selectedGameId = gameId;
            }

            confirmGameSelection() {
                console.log(`âœ… ç¢ºèªé¸æ“‡éŠæˆ²: ${this.selectedGameId}`);
                this.closeGameSelector();
                this.gameEngine.switchGame(this.selectedGameId);
            }
        }

        // å‰µå»ºå…¨åŸŸå¯¦ä¾‹ - ç§»åˆ°é é¢è¼‰å…¥å¾Œ
        let arduino;

        // å…¨åŸŸå‡½æ•¸å®šç¾©
        function connect() {
            if (arduino) arduino.connect();
        }

        function disconnect() {
            if (arduino) arduino.disconnect();
        }

        function toggleMonitoring() {
            if (arduino) {
                if (arduino.monitoring) {
                    arduino.stopMonitoring();
                } else {
                    arduino.startMonitoring();
                }
            }
        }

        function startCurrentGame() {
            if (arduino && arduino.gameEngine) {
                arduino.gameEngine.startGame();
            }
        }

        function resetCurrentGame() {
            if (arduino && arduino.gameEngine) {
                arduino.gameEngine.resetGame();
            }
        }

        function confirmGameSelection() {
            if (arduino) arduino.confirmGameSelection();
        }

        function closeGameSelector() {
            if (arduino) arduino.closeGameSelector();
        }

        function testAllButtons() {
            console.log('ğŸ§ª æ¸¬è©¦æ‰€æœ‰æŒ‰éˆ•...');
            for (let i = 0; i < 9; i++) {
                setTimeout(() => {
                    if (arduino) arduino.highlightButton(`btn${i}`);
                }, i * 200);
            }
        }

        function clearEventQueue() {
            if (arduino) {
                arduino.buttonEventQueue = [];
                console.log('ğŸ—‘ï¸ äº‹ä»¶éšŠåˆ—å·²æ¸…é™¤');
            }
        }

        function toggleDebugMode() {
            if (arduino && arduino.gameEngine) {
                arduino.gameEngine.debugMode = !arduino.gameEngine.debugMode;
                console.log('ğŸ”§ èª¿è©¦æ¨¡å¼:', arduino.gameEngine.debugMode ? 'é–‹å•Ÿ' : 'é—œé–‰');
            }
        }

        function autoDetectIP() {
            const lastSuccessfulIP = localStorage.getItem('lastArduinoIP');
            const ipInput = document.getElementById('ip');
            if (ipInput) {
                if (lastSuccessfulIP) {
                    ipInput.value = lastSuccessfulIP;
                    console.log(`ä½¿ç”¨ä¸Šæ¬¡æˆåŠŸçš„ IP: ${lastSuccessfulIP}`);
                } else if (typeof CONFIG !== 'undefined' && CONFIG.CONNECTION && CONFIG.CONNECTION.COMMON_IPS) {
                    ipInput.value = CONFIG.CONNECTION.COMMON_IPS[0];
                } else {
                    ipInput.value = '192.168.137.200';
                }
            }
        }

        function addQuickConnectButtons() {
            const connectPanel = document.querySelector('.panel');
            if (!connectPanel) return;

            const buttonContainer = document.createElement('div');
            buttonContainer.style.marginTop = '10px';

            const commonIPs = ['192.168.1.100', '192.168.4.1', '192.168.0.100', '192.168.137.200'];

            buttonContainer.innerHTML = `
        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <span style="align-self: center; margin-right: 10px;">å¿«é€Ÿé€£æ¥:</span>
            ${commonIPs.map(ip =>
                `<button class="primary" style="padding: 5px 10px; font-size: 12px;"
                 onclick="quickConnect('${ip}')">${ip}</button>`
            ).join('')}
        </div>
    `;
            connectPanel.appendChild(buttonContainer);
        }

        function quickConnect(ip) {
            const ipInput = document.getElementById('ip');
            if (ipInput) {
                ipInput.value = ip;
                if (arduino) arduino.connect();
            }
        }

        function createButtonMatrix() {
            const matrix = document.getElementById('buttonMatrix');
            if (!matrix) return;

            matrix.innerHTML = `
        ${Array(9).fill(0).map((_, i) =>
                `<div class="btn" id="btn${i}">${i + 1}</div>`
            ).join('')}
    `;

            const controls = document.querySelector('.controls');
            if (controls) {
                controls.innerHTML = `
            <button class="special-button reset-btn" id="resetBtn">é‡ç½®</button>
            <button class="special-button game-select-btn" id="gameBtn">éŠæˆ²é¸æ“‡</button>
            <button class="special-button confirm-btn" id="confirmBtn">ç¢ºèª</button>
        `;
            }
        }

        function createGameSelector() {
            const selector = document.querySelector('.game-selector');
            if (!selector) return;

            const games = [
                { id: 0, name: 'äº•å­—éŠæˆ²', icon: 'ğŸ¯', desc: 'ç¶“å…¸ä¸‰å­æ£‹éŠæˆ²' },
                { id: 1, name: 'è¨˜æ†¶éŠæˆ²', icon: 'ğŸ§ ', desc: 'è¨˜ä½æŒ‰éˆ•åºåˆ—' },
                { id: 2, name: 'åæ‡‰éŠæˆ²', icon: 'âš¡', desc: 'æ¸¬è©¦åæ‡‰é€Ÿåº¦' }
            ];

            selector.innerHTML = `
        <h2>ğŸ® é¸æ“‡éŠæˆ²</h2>
        <div class="game-options">
            ${games.map(game => `
                <div class="game-option" data-game="${game.id}">
                    <div class="game-number">${game.id + 1}</div>
                    <div class="game-icon">${game.icon}</div>
                    <div class="game-name">${game.name}</div>
                    <div class="game-description">${game.desc}</div>
                </div>
            `).join('')}
        </div>
        <div class="selector-instructions">
            <div class="instruction-title">ğŸ¯ æ“ä½œèªªæ˜</div>
            <div class="instruction-text">
                â€¢ æŒ‰æ•¸å­—éµ 1-3 é¸æ“‡éŠæˆ²<br>
                â€¢ æŒ‰ç¢ºèªéµé–‹å§‹éŠæˆ²<br>
                â€¢ æŒ‰é‡ç½®éµå–æ¶ˆé¸æ“‡
            </div>
        </div>
    `;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Arduino éŠæˆ²æ§åˆ¶å™¨é–‹å§‹åˆå§‹åŒ–...');

            // å‰µå»º Arduino æ§åˆ¶å™¨å¯¦ä¾‹
            arduino = new ArduinoController();

            // åˆå§‹åŒ– UI å…ƒç´ 
            createButtonMatrix();
            createGameSelector();
            autoDetectIP();
            addQuickConnectButtons();

            // åˆå§‹åŒ–éŠæˆ²
            if (arduino.gameEngine) {
                arduino.gameEngine.switchGame(0);
            }

            // æ›´æ–°é€£æ¥æŒ‰éˆ•ç‹€æ…‹
            arduino.updateConnectionButtons(false);

            console.log('Arduino éŠæˆ²æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>

</html>
